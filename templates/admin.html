<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ç®¡ç†å‘˜ - ç¥¨åŠ¡ç³»ç»Ÿ</title>
<style>
body{font-family: sans-serif; max-width: 900px; margin:20px auto}
section{border:1px solid #ddd;padding:12px;margin-bottom:12px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #eee;padding:6px;text-align:left}
</style>
</head>
<body>
<h2>ç®¡ç†å‘˜é¢æ¿</h2>

<section style="background:#fffacd; border:2px solid #ff6b6b; padding:12px; margin-bottom:12px;">
  <h3>å–ç¥¨çª—å£ç®¡ç†</h3>
  <div style="margin-bottom:12px;">
    <b>å½“å‰çŠ¶æ€ï¼š</b> <span id="ticket-status-display" style="padding:4px 8px; border-radius:4px; background:#90EE90;">æœªå¼€æ”¾</span>
  </div>
  <button onclick="openTicketWindow()" style="background:#90EE90; margin-right:8px;">å¼€æ”¾å–ç¥¨</button>
  <button onclick="closeTicketWindow()" style="background:#ffcccc;">å…³é—­å–ç¥¨</button>
</section>

<section style="background:#f0e6ff; border:2px solid #9370db; padding:12px; margin-bottom:12px;">
  <h3>æœ¬åœ°å¯†é’¥å¼€å…³ç®¡ç†</h3>
  <div style="margin-bottom:12px;">
    <b>å½“å‰çŠ¶æ€ï¼š</b> <span id="local-key-status-display" style="padding:4px 8px; border-radius:4px; background:#90EE90;">å…³é—­</span>
  </div>
  <button onclick="openLocalKeySwitch()" style="background:#90EE90; margin-right:8px;">æ‰“å¼€å¯†é’¥</button>
  <button onclick="closeLocalKeySwitch()" style="background:#ffcccc;">å…³é—­å¯†é’¥</button>
  <div style="margin-top:12px; font-size:12px; color:#666;">
    <p>ğŸ’¡ è¯´æ˜ï¼šæ‰“å¼€æ—¶ï¼Œå‰ç«¯ä¼šæ˜¾ç¤ºå¯†é’¥è¾“å…¥æ¡†ï¼Œç”¨æˆ·éœ€è¦æ‰«çº¿ä¸‹äºŒç»´ç è·å–å¯†é’¥æ‰èƒ½é¢†ç¥¨</p>
  </div>
</section>

<section style="background:#e6f3ff; border:2px solid #4169e1; padding:12px; margin-bottom:12px;">
  <h3>åº§ä½é›†åˆç®¡ç†ï¼ˆä»…åœ¨å–ç¥¨çª—å£å¼€æ”¾æ—¶ç”Ÿæ•ˆï¼‰</h3>
  <div id="seat-groups-info" style="margin-bottom:12px;"></div>
  <div style="display:flex; gap:20px;">
    <div style="flex:1;">
      <h4>é›†åˆ 1</h4>
      <button id="btn-group1" onclick="toggleSeatGroup(1)" style="background:#90EE90; width:100%; padding:8px;">å¼€æ”¾</button>
      <div id="group1-stats" style="margin-top:8px; font-size:12px;"></div>
    </div>
    <div style="flex:1;">
      <h4>é›†åˆ 2</h4>
      <button id="btn-group2" onclick="toggleSeatGroup(2)" style="background:#90EE90; width:100%; padding:8px;">å¼€æ”¾</button>
      <div id="group2-stats" style="margin-top:8px; font-size:12px;"></div>
    </div>
  </div>
</section>

<section style="background:#fff0f5; padding:12px; margin-bottom:12px;">
  <h3>æµ‹è¯•å·¥å…·</h3>
  <button onclick="clearIPLog()" style="background:#ffb6c1;">ä¸€é”®æ¸…é™¤ IP è®°å½•</button>
</section>

<div id="stats"></div>

<section>
  <h3>åº§ä½ç®¡ç†</h3>
  <button onclick="loadSeats()">åˆ·æ–°åº§ä½</button>
  <button onclick="showAddSeat()">æ–°å¢åº§ä½</button>
  <div id="seats"></div>
</section>

<section>
  <h3>ç”¨æˆ·ç®¡ç†</h3>
  <button onclick="loadUsers()">åˆ·æ–°ç”¨æˆ·</button>
  <button onclick="showAddUser()">æ–°å¢ç”¨æˆ·</button>
  <div id="users"></div>
</section>

<section>
  <h3>æœ‰æ•ˆå­¦å·ï¼ˆvalid_idsï¼‰</h3>
  <button onclick="loadValidids()">åˆ·æ–°</button>
  <div>
    <input id="new_valid" placeholder="å­¦å·">
    <button onclick="addValid()">æ·»åŠ </button>
  </div>
  <div id="validids"></div>
</section>

<script>
function fetchJson(url, opts){
  return fetch(url, opts).then(r=>{
    if(!r.ok) return r.json().then(j=>{throw j});
    return r.json();
  })
}

function openTicketWindow(){
  fetchJson('/admin/api/ticket-status', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({is_open: 1})})
    .then(()=>{updateTicketStatus(); alert('å–ç¥¨çª—å£å·²å¼€æ”¾');})
    .catch(e=>alert('å¤±è´¥: '+JSON.stringify(e)));
}

function closeTicketWindow(){
  fetchJson('/admin/api/ticket-status', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({is_open: 0})})
    .then(()=>{updateTicketStatus(); alert('å–ç¥¨çª—å£å·²å…³é—­');})
    .catch(e=>alert('å¤±è´¥: '+JSON.stringify(e)));
}

function updateTicketStatus(){
  fetchJson('/admin/api/ticket-status').then(data=>{
    let isOpen = Boolean(data.is_open);
    let statusText = isOpen ? 'å¼€æ”¾ä¸­' : 'æœªå¼€æ”¾';
    let statusColor = isOpen ? '#ffcc00' : '#90EE90';
    document.getElementById('ticket-status-display').innerHTML = statusText;
    document.getElementById('ticket-status-display').style.background = statusColor;
    updateSeatGroups();
  }).catch(e=>console.error(e));
}

function updateSeatGroups(){
  fetchJson('/admin/api/seat-groups').then(groups=>{
    let info = '<b>é›†åˆæ¦‚è§ˆï¼š</b> ';
    groups.forEach(g => {
      let statusColor = g.is_open ? '#ffcc00' : '#ddd';
      let statusText = g.is_open ? 'å¼€æ”¾' : 'å…³é—­';
      info += `é›†åˆ${g.group_id}: <span style="background:${statusColor}; padding:2px 6px; border-radius:3px;">${statusText}</span> `;
    });
    document.getElementById('seat-groups-info').innerHTML = info;
    
    // æ›´æ–°å„é›†åˆçš„ç»Ÿè®¡
    groups.forEach(g => {
      let statDiv = document.getElementById(`group${g.group_id}-stats`);
      let btn = document.getElementById(`btn-group${g.group_id}`);
      btn.style.background = g.is_open ? '#ffcc00' : '#90EE90';
      btn.innerHTML = g.is_open ? 'å…³é—­' : 'å¼€æ”¾';
      statDiv.innerHTML = `æ€»åº§ä½: ${g.total} | å·²å : ${g.occupied} | å‰©ä½™: ${g.available}`;
    });
  }).catch(e=>console.error(e));
}

function toggleSeatGroup(groupId){
  fetchJson('/admin/api/seat-groups').then(groups=>{
    let group = groups.find(g => g.group_id === groupId);
    let newState = group.is_open ? 0 : 1;
    let action = newState ? 'å¼€æ”¾' : 'å…³é—­';
    
    fetchJson(`/admin/api/seat-groups/${groupId}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({is_open: newState})
    }).then(()=>{
      updateSeatGroups();
      alert(`é›†åˆ ${groupId} å·²${action}`);
    }).catch(e=>alert('å¤±è´¥: '+JSON.stringify(e)));
  });
}

function clearIPLog(){
  if(!confirm('ç¡®è®¤ä¸€é”®æ¸…é™¤æ‰€æœ‰ IP è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
  fetchJson('/admin/api/clear-ip-log', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})})
    .then(data=>alert(data.msg))
    .catch(e=>alert('å¤±è´¥: '+JSON.stringify(e)));
}

function loadStats(){
  fetchJson('/admin/api/stats').then(j=>{
    document.getElementById('stats').innerHTML =
      `<b>åº§ä½æ€»æ•°</b>: ${j.total_seats} &nbsp; <b>å·²åˆ†é…</b>: ${j.allocated} &nbsp; <b>æœªåˆ†é…</b>: ${j.free} &nbsp; <b>ç”¨æˆ·æ•°</b>: ${j.user_count}`;
  }).catch(e=>console.error(e));
}

let seatsData = [];
function renderSeatsPage() {
  let html = '<table><tr><th>seat_id</th><th>pos</th><th>occupied</th><th>student_id</th><th>student_name</th><th>æ“ä½œ</th></tr>';
  seatsData.forEach(s=>{
    html += `<tr><td>${s.seat_id}</td><td>${s.pos||''}</td><td>${s.occupied}</td><td>${s.student_id||''}</td><td>${s.student_name||''}</td>`+
            `<td><button onclick="delSeat('${s.seat_id}')">åˆ é™¤</button></td></tr>`;
  });
  html += '</table>';
  document.getElementById('seats').innerHTML = html;
}
function loadSeats(){
  fetchJson('/admin/api/seats').then(list=>{
    seatsData = list;
    renderSeatsPage();
    loadStats();
  }).catch(e=>{document.getElementById('seats').innerText = JSON.stringify(e)});
}

function delSeat(id){
  if(!confirm('åˆ é™¤åº§ä½ '+id+' ?')) return;
  fetchJson('/admin/api/seats/'+id, {method:'DELETE'}).then(()=>loadSeats()).catch(e=>alert(JSON.stringify(e)));
}

function showAddSeat(){
  let sid = prompt('è¾“å…¥æ–°åº§ä½ seat_id');
  if(!sid) return;
  let occ = confirm('æ˜¯å¦æ ‡è®°ä¸ºå·²å ç”¨ï¼Ÿç‚¹å‡»ç¡®å®šåˆ™ä¸ºå·²å ç”¨');
  let student = null;
  if(occ) student = prompt('è¯·è¾“å…¥å ç”¨å­¦å·');
  fetchJson('/admin/api/seats', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({seat_id:sid, occupied:occ, student_id:student})}).then(()=>loadSeats()).catch(e=>alert(JSON.stringify(e)));
}

let usersData = [];
let usersPage = 1;
const usersPageSize = 30;
function renderUsersPage() {
  let start = (usersPage-1)*usersPageSize;
  let end = start + usersPageSize;
  let keys = Object.keys(usersData);
  let pageKeys = keys.slice(start, end);
  let html = '<table><tr><th>student_id</th><th>student_name</th><th>seat_id</th><th>pos</th><th>æ“ä½œ</th></tr>';
  pageKeys.forEach(i=>{
    let item = usersData[i];
    html += `<tr><td>${item.student_id}</td><td>${item.student_name||''}</td><td>${item.seat_id}</td><td>${item.pos||''}</td><td><button onclick="delUser('${item.student_id}')">åˆ é™¤</button></td></tr>`;
  });
  html += '</table>';
  // åˆ†é¡µæ§ä»¶
  let totalPages = Math.ceil(keys.length / usersPageSize);
  if(totalPages > 1) {
    html += '<div style="margin:8px 0">';
    for(let i=1;i<=totalPages;i++){
      if(i===usersPage) html += `<b>[${i}]</b> `;
      else html += `<a href="#" onclick="gotoUsersPage(${i});return false;">${i}</a> `;
    }
    html += '</div>';
  }
  document.getElementById('users').innerHTML = html;
}
function gotoUsersPage(p) {
  usersPage = p;
  renderUsersPage();
}
function loadUsers(){
  fetchJson('/admin/api/users').then(arr=>{
    // API è¿”å›æ•°ç»„ [{student_id, seat_id, student_name}, ...]
    usersData = arr || [];
    usersPage = 1;
    renderUsersPage();
    loadStats();
  }).catch(e=>{document.getElementById('users').innerText = JSON.stringify(e)});
}

function delUser(id){
  if(!confirm('åˆ é™¤ç”¨æˆ· '+id+' ?')) return;
  fetchJson('/admin/api/users/'+id, {method:'DELETE'}).then(()=>loadUsers()).catch(e=>alert(JSON.stringify(e)));
}

function showAddUser(){
  let sid = prompt('å­¦å·'); if(!sid) return;
  let seat = prompt('åº§ä½å·'); if(!seat) return;
  fetchJson('/admin/api/users', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({student_id:sid, seat_id:seat})}).then(()=>loadUsers()).catch(e=>alert(JSON.stringify(e)));
}

function loadValidids(){
  fetchJson('/admin/api/validids').then(list=>{
    let html = '<table><tr><th>student_id</th><th>student_name</th><th>æ“ä½œ</th></tr>';
    list.forEach(v=> html += `<tr><td>${v.student_id}</td><td>${v.student_name||''}</td><td><button onclick="delValid('${v.student_id}')">åˆ é™¤</button></td></tr>`);
    html += '</table>';
    document.getElementById('validids').innerHTML = html;
  }).catch(e=>document.getElementById('validids').innerText = JSON.stringify(e));
}

function addValid(){
  let v = document.getElementById('new_valid').value.trim(); if(!v) return;
  fetchJson('/admin/api/validids', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({student_id: v})}).then(()=>{document.getElementById('new_valid').value=''; loadValidids();}).catch(e=>alert(JSON.stringify(e)));
}

function delValid(v){
  if(!confirm('åˆ é™¤å­¦å· '+v+' ?')) return;
  fetchJson('/admin/api/validids/'+v, {method:'DELETE'}).then(()=>loadValidids()).catch(e=>alert(JSON.stringify(e)));
}

function openLocalKeySwitch(){
  fetchJson('/admin/api/local-key-switch', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({is_open: 1})})
    .then(()=>{updateLocalKeyStatus(); alert('æœ¬åœ°å¯†é’¥å¼€å…³å·²æ‰“å¼€');})
    .catch(e=>alert('å¤±è´¥: '+JSON.stringify(e)));
}

function closeLocalKeySwitch(){
  fetchJson('/admin/api/local-key-switch', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({is_open: 0})})
    .then(()=>{updateLocalKeyStatus(); alert('æœ¬åœ°å¯†é’¥å¼€å…³å·²å…³é—­');})
    .catch(e=>alert('å¤±è´¥: '+JSON.stringify(e)));
}

function updateLocalKeyStatus(){
  fetchJson('/admin/api/local-key-switch').then(data=>{
    let isOpen = Boolean(data.is_open);
    let statusText = isOpen ? 'æ‰“å¼€ä¸­' : 'å…³é—­';
    let statusColor = isOpen ? '#ffcc00' : '#90EE90';
    document.getElementById('local-key-status-display').innerHTML = statusText;
    document.getElementById('local-key-status-display').style.background = statusColor;
  }).catch(e=>console.error(e));
}

// åˆå§‹åŠ è½½
updateTicketStatus(); updateLocalKeyStatus(); loadStats(); loadSeats(); loadUsers(); loadValidids();
</script>
</body>
</html>
