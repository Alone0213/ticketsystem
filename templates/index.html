<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>领票系统</title>
<style>
body { font-family: sans-serif; max-width: 400px; margin: 40px auto; }
input { width: 100%; padding: 10px; font-size: 18px; }
button { width: 100%; padding: 10px; margin-top: 10px; font-size: 18px; }
</style>
</head>
<body>

<h2>电子领票系统</h2>
<div id="status-info" style="margin-bottom:12px; padding:8px; background:#f0f0f0; border-radius:4px;"></div>
<input id="sid" placeholder="请输入学号">
<input id="sname" placeholder="请输入姓名" style="margin-top:8px" hidden>
<button onclick="submit()">确认领取</button>

<div id="available-seats" style="margin-top:15px; padding:8px; background:#e8f4f8; border-radius:4px; text-align:center;">
    <b>剩余座位数：</b><span id="seats-count">--</span> / <span id="seats-total">--</span>
</div>

<p id="result"></p>

<script>
let isTicketOpen = false;

// 获取剩余座位数和总座位数
function loadAvailableSeats(){
    fetch("/api/available-seats")
        .then(r => r.json())
        .then(data => {
            let available = data.available || 0;
            let total = data.total || 0;
            document.getElementById('seats-count').textContent = available;
            document.getElementById('seats-total').textContent = total;
        })
        .catch(() => {
            document.getElementById('seats-count').textContent = '?';
            document.getElementById('seats-total').textContent = '?';
        });
}

// 初始化：获取取票窗口状态和座位集合状态
function initStatus(){
    // 先获取顶层取票权限
    fetch("/admin/api/ticket-status")
        .then(r => r.json())
        .then(ticketData => {
            isTicketOpen = Boolean(ticketData.is_open);
            
            // 如果顶层未开放，直接显示未开放
            if (!isTicketOpen) {
                document.getElementById('status-info').innerHTML =
                    `<b>取票通道：</b> <span style="background:#90EE90; padding:2px 6px; border-radius:3px;">未开放</span>`;
                document.getElementById("sname").hidden = true;
                document.getElementById("sname").value = '';
                return;
            }
            
            // 顶层已开放，检查集合状态
            fetch("/admin/api/seat-groups")
                .then(r => r.json())
                .then(groups => {
                    // 检查是否有任一集合开放
                    let anyGroupOpen = groups.some(g => Boolean(g.is_open));
                    let statusText = anyGroupOpen ? '开放中' : '未开放';
                    let statusColor = anyGroupOpen ? '#ffcc00' : '#90EE90';
                    document.getElementById('status-info').innerHTML =
                        `<b>取票通道：</b> <span style="background:${statusColor}; padding:2px 6px; border-radius:3px;">${statusText}</span>`;
                    
                    // 当顶层开放时，总是显示姓名框
                    document.getElementById("sname").hidden = false;
                })
                .catch(() => {
                    // 获取集合失败，假设有开放的集合
                    document.getElementById('status-info').innerHTML =
                        `<b>取票通道：</b> <span style="background:#ffcc00; padding:2px 6px; border-radius:3px;">开放中</span>`;
                    document.getElementById("sname").hidden = false;
                });
        })
        .catch(() => {
            document.getElementById('status-info').innerHTML = '<b>取票窗口：</b> 无法获取状态';
        });
}

function submit(){
    let sid = document.getElementById("sid").value.trim();
    let sname = document.getElementById("sname").value.trim();
    let formData = new FormData();
    formData.append("student_id", sid);
    formData.append("student_name", sname);

    fetch("/ticket", { method: "POST", body: formData })
        .then(r => r.json())
        .then(data => {
            if (data && data.status === 'admin_redirect' && data.url) {
                // 管理员密钥，跳转到受保护的 /admin（浏览器会提示 Basic Auth）
                window.location.href = data.url;
                return;
            }
            let displayMsg = data.msg || '';
            if (data.seat) {
                displayMsg += " 座位号：" + data.seat;
                if (data.pos) {
                    displayMsg += " | 位置：" + data.pos;
                }
            }
            document.getElementById("result").innerHTML = displayMsg;
            // 领票成功后更新剩余座位数
            if(data.status === 'ok'){
                loadAvailableSeats();
            }
        })
        .catch(() => {
            document.getElementById("result").innerHTML = "出错，请重试";
        });
}

// 页面加载时初始化状态和剩余座位数
window.addEventListener('load', function(){
    initStatus();
    loadAvailableSeats();
});
</script>

</body>
</html>
