<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>领票系统</title>
<style>
body { font-family: sans-serif; max-width: 400px; margin: 40px auto; }
input { width: 100%; padding: 10px; font-size: 18px; }
button { width: 100%; padding: 10px; margin-top: 10px; font-size: 18px; }
</style>
</head>
<body>

<h2>电子领票系统</h2>
<div id="status-info" style="margin-bottom:12px; padding:8px; background:#f0f0f0; border-radius:4px;"></div>
<input id="sid" placeholder="请输入学号">
<input id="sname" placeholder="请输入姓名" style="margin-top:8px" hidden>
<button onclick="submit()">确认领取</button>

<div id="available-seats" style="margin-top:15px; padding:8px; background:#e8f4f8; border-radius:4px; text-align:center;">
    <b>剩余座位数：</b><span id="seats-count">--</span>
</div>

<p id="result"></p>

<script>
let isTicketOpen = false;

// 获取剩余座位数
function loadAvailableSeats(){
    fetch("/api/available-seats")
        .then(r => r.json())
        .then(data => {
            let count = data.available || 0;
            document.getElementById('seats-count').textContent = count;
        })
        .catch(() => {
            document.getElementById('seats-count').textContent = '?';
        });
}

// 初始化：获取取票窗口状态
function initStatus(){
    fetch("/admin/api/ticket-status")
        .then(r => r.json())
        .then(data => {
            isTicketOpen = Boolean(data.is_open);
            let statusText = isTicketOpen ? '开放中' : '未开放';
            let statusColor = isTicketOpen ? '#ffcc00' : '#90EE90';
            document.getElementById('status-info').innerHTML =
                `<b>取票通道：</b> <span style="background:${statusColor}; padding:2px 6px; border-radius:3px;">${statusText}</span>`;
            
            // 根据状态显示/隐藏姓名框
            let snameInput = document.getElementById("sname");
            if(isTicketOpen) {
                // 开放时，显示姓名框
                snameInput.hidden = false;
            } else {
                // 关闭时，隐藏姓名框
                snameInput.hidden = true;
                snameInput.value = '';
            }
        })
        .catch(() => {
            document.getElementById('status-info').innerHTML = '<b>取票窗口：</b> 无法获取状态';
        });
}

function submit(){
    let sid = document.getElementById("sid").value.trim();
    let sname = document.getElementById("sname").value.trim();
    let formData = new FormData();
    formData.append("student_id", sid);
    formData.append("student_name", sname);

    fetch("/ticket", { method: "POST", body: formData })
        .then(r => r.json())
        .then(data => {
            if (data && data.status === 'admin_redirect' && data.url) {
                // 管理员密钥，跳转到受保护的 /admin（浏览器会提示 Basic Auth）
                window.location.href = data.url;
                return;
            }
            let displayMsg = data.msg || '';
            if (data.seat) {
                displayMsg += " 座位号：" + data.seat;
                if (data.pos) {
                    displayMsg += " | 位置：" + data.pos;
                }
            }
            document.getElementById("result").innerHTML = displayMsg;
            // 领票成功后更新剩余座位数
            if(data.status === 'ok'){
                loadAvailableSeats();
            }
        })
        .catch(() => {
            document.getElementById("result").innerHTML = "出错，请重试";
        });
}

// 页面加载时初始化状态和剩余座位数
window.addEventListener('load', function(){
    initStatus();
    loadAvailableSeats();
});
</script>

</body>
</html>
